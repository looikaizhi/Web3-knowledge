# 流动性提供者的隐藏风险：无常损失

相信各位刚开始接触DeFi时，都曾想过以后等赚到好多好多钱，要把钱存入一个很高APY的流动池，能够钱生钱。通常LP（流动性提供者）的收益来源是由几个部分组成的：交易手续费、流动性挖矿奖励、借贷、收益聚合器等等。但其实这里面是存在风险的，那就是无常损失（Impermanent Loss)，相信部分DeFi爱好者肯定听过这个词，可是如果你在网上搜索会发现解释得非常深奥。本文会以最基础的Uniswap V2的DEX逻辑和流动性池子结合实际例子，也会有一些简单的数学公式（初中水平）来探讨无常损失为什么会存在呢。

# 价格
![image](https://github.com/user-attachments/assets/f40c5851-5d9e-4c24-a62b-58320e2092ee)

价格是两种物品兑换的一种比例。试想想在古代还未出现货币的时代，人们是如何进行交易的，答案就是以物易物。即使在古代，养鸡肯定会比养猪来得简单，也造成鸡和猪的价值有差异。但这不是重点，比如当时的市场标准是2头猪换8只鸡，通过这个交易我们可以计算出它们的相对价格，猪的价格为4 鸡/猪；鸡的价格为 0.25 猪/鸡。

现在在把鸡和猪转换成数字货币 $$(A,$$ $$B)$$，分别有 $$x_0$$个 $$A$$和 $$y_0$$个 $$B$$。那它们各自的价格为：

$$Price_A=\frac{y_0}{x_0},\qquad  Price_B=\frac{x_0}{y_0}$$

# Uniswap V2
在正式介绍无常损失前，先复习Uniswap V2的AMM模型机制。Uniswap是一个去中心化交易所（DEX），那既然是交易所，那资金池从哪里来呢？谁提供流动性？

这一切背后的主角就是AMM（自动做市商）模型了。在Uniswap中，用户按要求比例1:1的两种资金存入流动性池（也就是资金池）内，为DEX提供了流动性，任何人都可以成为LP。在传统的订单簿模式中，无论一方是买方/卖方，都需要另一卖方/买方来互相交易，需要等待匹配成功才能进行交易。而使用AMM则无需等待匹配，每次交易只需动用流动性池的资金就行了，当然你也可以理解成LP就是对手方。
![image](https://github.com/user-attachments/assets/46259bc7-cb11-462b-8317-bdad05e45356)

Uniswap V2 AMM模型的特点：
1. 把 $$x个A$$, $$y个B$$的两种币放入流动性池，确保它们的价值相等， $$Price_A \times x=Price_B \times y $$
2. 流动性池中代币的数量必须满足 $$x\times y=k$$，在不加减池子的情况下 $$k$$是个固定值。
3. 价格是基于池中代币的相对数量计算，和上述价格的定义相同，因此能够自动计算价格。

![image](https://github.com/user-attachments/assets/8af5b664-1b34-429e-b2e5-e7fe919fb3cb)

假设有人在Uniswap V2来进行交易，想买 $$y_1$$个 $$B$$，那他需要使用 $$x_1$$个 $$A$$来兑换，且流动性池中代币数量必须满足 $$x\times y=k$$。也就是需满足以下条件：
设 $$x_0,y_0$$分别为 $$A,B$$的数量 $$(y_0>y_1)$$， $$k_0$$是由 $$x_0,y_0$$定义的常数。

$$(x_0+x_1)\times(y_0-y_1)=k_0=x_0\times y_0$$

计算需要多少个 $$A$$来购买：

$$x_1=\frac{k_0}{y_0-y_1}-x_0=\frac{x_0y_1}{y_0-y_1}$$

所以他买$$B$$的平均价格为$$Price_B'$$：

$$Price_B'=\frac{x_1}{y_1}=\frac{x_0}{y_0-y_1}$$

明显看到 $$B$$的价格变得更贵了。
如果流动池足够大 $$(x_0,y_0>>x_1,y_1)$$，那买卖形成的差价会小很多：

$$Price_B'=\frac{x_0}{y_0-y_1}\approx \frac{x_0}{y_0}$$

当卖出 $$B$$， $$B$$的价格也会变得更便宜了，这部分可以试试自己推导。

实际上 $$k$$是可以被改变的。当LP提供流动性时，由于同时增加 $$x$$和 $$y$$，因此 $$k$$上升；当LP退出流动性时，由于同时减少 $$x$$和 $$y$$，因此 $$k$$下降。但是在交易时， $$k$$不变。可能有点绕，后面讲解实际例子就应该理解了。

AMM模型的流动性池必须由一对代币绑定组成。试想如果池子只包含ETH，没有另一个代币，AMM还能运行吗？
1. 价格无法被确定，因为去中心化，即使外部市场价格发生了变化，池子也无法通过内部机制调整ETH的数量来反映最新价格。
2. 用户无法用其他代币交换ETH，因为池子没有可供交换的另一种代币。
3. LP承担所有市场风险。例如ETH价格下跌，LP的资产价值将全部受到影响，无法通过另一种代币分散风险。

# 价格差距的修正机制
在前面我们有说到，在Uniswap中池子的价格并不取决于市场价，而是通过代币的数量来定义其价格，这难道不会造成Uniswap和其他CEX（中心化交易所）中的价格出现巨大的偏离吗？

实际上确实会于外部市场价格存在差距，可是这种价格差距并不会持续太久，因此市场中会有一批嗅觉灵敏的投机者（套利者）通过这种价格上的差距来进行套利，使得价格很快就能近似于外部市场价格。因此Uniswap也明白，并不需要设计太复杂的机制或通过任何预言机来获取外部市场数据，用户或套利者会自行把市场真实情况反馈至Uniswap中。

![image](https://github.com/user-attachments/assets/bd035999-eac8-4add-b164-fb5adc395f2c)

套利的工作原理：
1. Uniswap上的ETH价格高于Binance
   a. 假设在Uniswap上，ETH的价格为 $$3000u$$，而在Binance上价格为 $$2900u$$。
   b. 套利者会在Binance上购买ETH，并将其卖到Uniswap，赚取差价。
   c. 这样使得Uniswap上的ETH变多，因此ETH价格下跌，直到价格接近或等于外部市场价格。
  
2. Uniswap上的ETH价格低于Binance
   a. 假设在Uniswap上，ETH的价格为 $$3000u$$，而在Binance上价格为 $$3100u$$。
   b. 套利者会在Uniswap上购买ETH，并将其卖到Binance，赚取差价。
   c. 这样使得Uniswap上的ETH变少，因此ETH价格上涨，直到价格接近或等于外部市场价格。

# 无常损失
![image](https://github.com/user-attachments/assets/5caf0280-fc2c-4b53-871f-7e6e4a347d96)

![image](https://github.com/user-attachments/assets/d3c7e073-fb79-4cbe-a9fc-d0f418ae1db8)

老实说我不知道该如何用文字去描述无常损失，因此我希望通过实际的例子让大家能够更直观地感受它。接下来我将用时间线梳理的方式进行讲解。

|时间   |ETH价格 |ETH数量 |USDT数量 |LP仓位价值 |持币价值 |k值          |无常损失 |
|:-----:|:-----:|:-----:|:-------:|:--------:|:-------:|:-----------:|:------:|
|$$T_0$$|3000   |2      |6000     |12000     |12000    |2x6000=12000 |—       |
假设你想成为LP，为Uniswap V2上的ETH/USDT池子提供流动性来赚取一些被动收入。在 $$T_0$$的时间点上， ETH价格为 $$3000u$$， USDT价格为 $$1u$$（USDT是稳定币，假设它一直都是 $$1u$$）。由于存入的ETH和USDT价值必须相等，即 $$Value_{ETH}=Price_{ETH} \times x, \quad Value_{USDT}=Price_{USDT} \times y, \quad Value_{ETH}=Value_{USDT}$$，因此你把手上的2个ETH和6000个USDT存入池中，此时你的LP仓位价值为 $$12000u$$。如果你没把代币存入池子，其代币在你钱包的价值也是 $$12000u$$。

|时间   |ETH价格 |ETH数量 |USDT数量 |LP仓位价值 |持币价值 |k值          |无常损失 |
|:-----:|:-----:|:-----:|:-------:|:--------:|:-------:|:-----------:|:------:|
|$$T_0$$|3000   |2      |6000     |12000     |12000    |2x6000=12000 |—       |
|$$T_1$$|4000   |       |         |          |         |             |        |

假设ETH涨到 $$4000u$$了（ $$T_1$$的时间点），此时你会发现 ETH价值为 $$8000u$$， USDT价值为 $$6000u$$，明显不相等，因为Uniswap V2池子中两个代币的价值必须相等。这时Uniswap会根据当前的价格来调整池中代币的数量。请记得Uniswap中的价格是由两个代币数量来决定的，也就说现在ETH涨到 $$4000u$$是因为其数量在池中变得更少了且USDT变多了，所以贵了。那现在我们试试计算ETH和USDT分别数量为多少：

设ETH相对于USDT的价格变化率为 $$\rho$$， $$Price'$$为最新价格， $$x'$$和 $$y'$$分别为ETH和USDT的数量。

$$Price_{ETH}'=\rho Price_{ETH}$$

$$Price_{ETH}=\frac{y}{x}, \qquad Price_{ETH}'=\frac{y'}{x'}$$

由于池子代币的数量必须满足 $$x\times y=k$$，因此有：

$$k=x\times y=x'\times y'$$

$$x\times y=x'\times(x'\times \rho Price_{ETH})$$

$$x\times y=\rho x'^{2}\times \frac{y}{x}$$

整理后分别得到 $$x'$$和 $$y'$$：

$$x'=\frac{x}{\sqrt{\rho}}$$

$$y'=\sqrt{\rho}\,y$$

|时间   |ETH价格 |ETH数量 |USDT数量 |LP仓位价值 |持币价值 |k值              |无常损失 |
|:-----:|:-----:|:-----:|:-------:|:--------:|:-------:|:---------------:|:------:|
|$$T_0$$|3000   |2      |6000     |12000     |12000    |2x6000=12000     |—       |
|$$T_1$$|4000   |1.732  |6928     |13856     |14000    |1.732x6928=12000 |144     |

由于ETH价格上涨至 $$4000u$$， $$\rho=\frac{4}{3}$$，计算得出 $$x'=1.732\;,y'=6928$$。我们可以通过计算其 $$k$$值判断是否符合 $$k=x'\times y'$$。我们计算LP仓位价值 $$=4000u\times1.732+1u\times6928=13856u$$，如果我们没把代币存入池中，持在手中，其价值为 $$=4000u\times2+1u\times6000=14000u$$。这时我们能够发现到，当代币的价格出现波动时，实际上会造成一定的损失。上述例子中因为成为LP而造成了损失 $$144u$$，如果持有代币并等待其慢慢增值，则不会有这个损失。
通过这个例子，相信你也明白无常损失的概念了，简单来说就是无常损失 = 持币价值 - LP仓位价值。

$$无常损失=1-\frac{LP仓位价值}{持币价值}$$ 

当然你可以尝试用上述的公式推导出以下公式（只适用于有稳定币的情况）：

$$无常损失=1-\frac{2\sqrt{\rho}}{\rho + 1}$$

|时间   |ETH价格 |ETH数量 |USDT数量 |LP仓位价值 |持币价值 |k值              |无常损失 |
|:-----:|:-----:|:-----:|:-------:|:--------:|:-------:|:---------------:|:------:|
|$$T_0$$|3000   |2      |6000     |12000     |12000    |2x6000=12000     |—       |
|$$T_1$$|4000   |1.732  |6928     |13856     |14000    |1.732x6928=12000 |144     |
|$$T_2$$|2000   |2.449  |4898     |9796      |10000    |2.449x4898=12000 |204     |

假设当ETH价格下跌至 $$2000u$$， $$\rho=\frac{2}{3}$$，可以计算出上表中的答案。

以下为无常损失函数的图表，从图表我们能够得知：
1. 当 $$\rho>1$$时，无常损失逐渐增大，但增幅缓慢。
2. 当 $$\rho<1$$时，无常损失逐渐增大，但曲线的陡峭程度很大，这意味者价格下跌时，LP会更快遭受较大的无常损失。
3. 当 $$\rho=1$$时，不发生无常损失。

![image](https://github.com/user-attachments/assets/b4f2af5d-83b9-485a-8a56-4647a3c91125)

总而言之，尽管流动性提供者能够通过手续费和奖励获得收益，但无常损失带来的潜在风险不容忽视。
